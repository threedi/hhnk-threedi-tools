name: tests

on:
  pull_request:
    types: [review_requested, ready_for_review]
    
jobs:
  run-pytests:
    if: github.event.pull_request.draft == false
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2
    #Hopefully reduces run time; see https://github.com/conda-incubator/setup-miniconda/issues/277
    - name: Rename conda package cache
      shell: bash
      run: mv "${CONDA_PKGS_DIR}" "${CONDA_PKGS_DIR}_do_not_cache"
    - uses: conda-incubator/setup-miniconda@v2
      with:
        python-version: 3.9
        # miniconda-version: "latest"
        mamba-version: "*"
        channels: conda-forge,defaults
        channel-priority: true
        activate-environment: hhnk_threedi
        environment-file: envs\environment_test.yml
    - name: Test
      shell: pwsh
      run: |
        conda info
        conda list
        pip install -e .
        pytest --cov-report term-missing --cov=hhnk_threedi_tools --cov-report=xml tests/
    - name: Upload coverage
      uses: codecov/codecov-action@v2

  fail_if_pull_request_is_draft:
    if: github.event.pull_request.draft == true
    runs-on: windows-latest
    steps:
    - name: Fails in order to indicate that pull request needs to be marked as ready to review and unit tests workflow needs to pass.
      run: exit 1